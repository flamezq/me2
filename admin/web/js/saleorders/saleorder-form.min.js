let switch_promo=0;let LoadAjax=()=>{$(".ew-add").hide();loadFindBox(".render-search-item")}
$(document).ready(function(){var random=0;route("index.php?r=SaleOrders/ajax/menu-random","GET",{param:{data:random}},"ResourceItemSearch");LoadAjax();if($("#saleheader-vat_percent").val()>0){$("#Exc-vat").show("fast")}else{$("#Exc-vat").hide("fast")}
if(Number($("#ew-line-total").attr("data"))<=0){$(".ew-sum-line").hide()}else{$(".ew-sum-line").show()}
getSumLine($("#ew-discount-amount").attr("data"),"discount");$("body").on("click","a.get-promotions-switch",function(){switch_promo=1});$("body").on("click","#click-label-discount",function(){$("#ew-discount-amount").focus().select()});$("body").find("#PickItem-Modal").on("shown.bs.modal",function(){$("html").addClass("freezePage");$("body").addClass("freezePage")});$("body").find("#PickItem-Modal").on("hidden.bs.modal",function(){$("html").removeClass("freezePage");$("body").removeClass("freezePage")})});(function($,window,document,undefined){$("#saleheader-payment_term").on("change",function(){var today=new Date();var date=new Date(today),days=parseInt($("#saleheader-payment_term").val(),10);if(!isNaN(date.getTime())){date.setDate(date.getDate()+days);$('input[id="saleheader-paymentdue"]').val(date.toInputFormat())}else{alert("Invalid Date")}});Date.prototype.toInputFormat=function(){var yyyy=this.getFullYear().toString();var mm=(this.getMonth()+1).toString();var dd=this.getDate().toString();return(yyyy+"-"+(mm[1]?mm:"0"+mm[0])+"-"+(dd[1]?dd:"0"+dd[0]))}})(jQuery,this,document);$("body").on("change","#saleheader-sales_people",function(){var $status=$("#saleheader-status").val();if($("#saleheader-customer_id").val()==""){if($.inArray($status,["Open","Cancel"])<0){$("#saleheader-status").val("Open");swal('ดูเหมือนว่า "ยังไม่ได้เลือกลูกค้า"',"กรุณาเลือกลูกค้า","warning");return!1}}});$("#Form-SaleOrder").on("keypress",function(e){var keyCode=e.keyCode||e.which;if(keyCode===13){e.preventDefault();return!1}});$("body").on("click","#ewSelect",function(){var that=this;$(that).find("i").attr("class","fas fa-sync-alt fa-spin");$(that).attr("disabled",!0);CreateBom($(".ew-Code").attr("ew-post-param"));var itemno=$(".ew-Validate").attr("data-key");var unit_price=$("input[name=Price]").val();if(unit_price==0){}
var data={param:{itemno:itemno,orderno:$("#saleheader-no").val(),itemset:$("#itemset").val(),soid:$("#SaleOrder").attr("ew-so-id"),amount:$("input[name=Quantity]").val(),price:$("input[name=Price]").val(),discount:$("input[name=Discount]").val()}};$.ajax({url:"index.php?r=SaleOrders/saleorder/create_saleline",type:"POST",data:data,success:function(res){$(".SaleLine").html(res);$("#PickItem-Modal").modal("hide");$("body").attr("style","overflow:auto;");$("#ewSelect").hide();getSumLine($("#ew-discount-amount").attr("data"),"discount");$("html, body").animate({scrollTop:$(".grid-view").offset().top-80},500);LoadAjax();$(that).find("i").attr("class","fa fa-check");$(that).attr("disabled",!1)}})});$("body").on("click",".ew-PickItem",function(){var data={param:{itemno:$(this).attr("itemno"),orderno:$("#saleheader-no").val(),pset:$(this).attr("itemset"),itemset:$(this).attr("itemset")}};if($(this).attr("ew-bom")==="enabled"){$.ajax({url:"index.php?r=Itemset/bomset/view&id="+$(this).attr("itemset"),type:"POST",data:data,async:!0,success:function(getData){$(".ew-create-item").html(getData);$("#PickToSaleLine").hide()}})}else{$.ajax({url:"index.php?r=SaleOrders/saleorder/viewitem&test=1",type:"POST",data:data,async:!1,success:function(response){$("body").find("div.ew-create-item").html(response)}});loadItem($("#itemno").val());$("#PickToSaleLine").hide()}
$(".modal-title").html($(this).attr("ew-set-name"));$("body").attr("style","overflow:hidden; margin-right:0px;")});$("body").on("mouseout",".ItemGrid",function(){$(".btn-detail-group").css("visibility","hidden")});$("body").on("change","#saleheader-vat_percent",function(){var thiscond=$(this).val();if($(this).val()>0){$("#Exc-vat").show("fast")}else{$("#Exc-vat").hide("fast")}
getSumLine($("#ew-discount-amount").attr("data"),"discount")});$("body").on("change","#saleheader-include_vat",function(){getSumLine($("#ew-discount-amount").attr("data"),"discount")});$("body").on("click",".RemoveSaleLine",function(){var itemno=$(this).attr("href");var id=itemno.substring(1);var orderno=$("#SaleOrder").attr("ew-so-id");var alt=$(this).attr("alt");var data={param:{lineno:id,orderno:orderno}};var tr=$('tr[data-key="'+itemno.substring(1)+'"]');$.get("index.php?r=SaleOrders/ajax/has-ship",{source:$(this).attr("href").substring(1)},function(getData){var obj=jQuery.parseJSON(getData);if(obj.id=="Pass"){if(confirm('ต้องการลบรายการ "'+alt+'" ?')){$.ajax({url:"index.php?r=SaleOrders/saleorder/delete_line",type:"POST",data:data,async:!0,success:function(getData){tr.css("background-color","#aaf7ff");tr.fadeOut(500,function(){tr.remove()});LoadAjax();getSumLine($("#ew-discount-amount").attr("data"),"discount");if(Number($("#ew-line-total").attr("data"))<=0){$(".ew-sum-line").hide()}else{$(".ew-sum-line").show()}}})}}else{swal("'สินค้าถูกบรรจุแล้ว'","ต้อง 'ยกเลิก' รายการ \""+obj.doc+'"  ก่อนทำการแก้ไข"',"warning");return!1}});return!1});$("body").on("change","#ew-text-editor",function(i,el){var $div=$.trim($(this).parent("div").parent("td").attr("class"));var input=$(this);if($div==="ew-sl-qty text-right"){var pre=$(this).parent("div").parent("td").parent("tr").find("a.RemoveSaleLine").attr("qty");var revert='<div id="ew-qty-edit" ew-line-no="'+input.attr("ew-lineno")+'">'+pre+"</div>"}else{var pre=$(this).parent("div").parent("td").parent("tr").find("a.RemoveSaleLine").attr("price");var revert='<div id="ew-price-edit" ew-line-no="'+input.attr("ew-lineno")+'">'+pre+"</div>"}
var data={param:{orderno:$("#saleheader-no").val(),lineno:$(this).attr("ew-lineno"),updatefield:$(this).attr("name"),edit:$(this).val()}};$.get("index.php?r=SaleOrders/ajax/has-ship",{source:$(this).attr("ew-lineno")},function(getData){var obj=jQuery.parseJSON(getData);if(obj.id=="Pass"){route("index.php?r=SaleOrders/saleorder/update-sale-line","POST",data,"SaleLine");LoadAjax();getSumLine($("#ew-discount-amount").attr("data"),"discount")}else{swal("สินค้าถูกบรรจุแล้ว","ต้อง 'ยกเลิก' รายการ \""+obj.doc+'"  ก่อนทำการแก้ไข"',"warning");input.parent("div").html(revert)}})});$("body").on("click",".ew-sl-qty",function(){var lineNumber=$(this).children("div").attr("ew-line-no");var value_txt=$(this).text().replace(",","");if(value_txt===""){value_txt=$(this).children("div").children("input").val()}
var text_qty='<div class="pull-right" ew-line-no="'+lineNumber+'"><input type="number" name="qty" id="ew-text-editor" value="'+value_txt+'" ew-lineno="'+lineNumber+'" class="form-control text-right" style="width:80px;"></div>';$(this).html(text_qty);$(this).children("div").children("input").focus();$(this).children("div").children("input").select()});$("body").on("click",".ew-sl-price",function(){var lineNumber=$(this).children("div").attr("ew-line-no");var value_txt=$(this).text().replace(",","");if(value_txt===""){value_txt=$(this).children("div").children("input").val()}
var text_qty='<div class="pull-right" ew-line-no="'+lineNumber+'"><input type="number" name="price" id="ew-text-editor" value="'+value_txt+'" ew-lineno="'+lineNumber+'" class="form-control text-right" style="width:100px;"></div>';$(this).html(text_qty);$(this).children("div").children("input").focus();$(this).children("div").children("input").select()});$("body").on("click",".ew-filter-onclick",function(el){var href=$(this).attr("href").slice(1);var $this=$(this);var data={param:{href:href}};var template='<div class="ccc" style="width: 100%;height: 100%;background: #00000078;position: absolute;z-index: 10;right: 0;"></div>';$(".FilterResource").prepend(template);$(".widget-user-image").addClass("text-right").html('<i class="fas fa-sync fa-spin fa-3x " style="margin-left: 29px;color:#fff"></i>');$(this).attr("style","background-color: #ccc;");$.ajax({url:"index.php?r=SaleOrders/ajax/items",data:data,type:"POST",async:!0,success:function(response){$("body").find(".ResourceItemSearch").html(response);$("body").find(".ccc").remove();$($this).attr("style"," ")}})});$("body").on("click",".ew-fsize span",function(e){$(".ew-type").toggle();$(".InsertItem").toggle();$(".InsertItem").focus()});$("body").on("keyup",".InsertItem",function(e){var len=$.trim($(this).val()).length;if(len>=3){if(e.which===32||e.which===13){FindItemsJson($(this))}
if(e.which==9){if($("#InsertDesc").attr("ew-item-code")!="eWinl"){$("#InsertDesc").first().focus()}
var inputItem=$.trim($(".InsertItem").val());$(".InsertItem").val(inputItem);$.ajax({url:"index.php?r=SaleOrders/ajax/json-find-item",type:"POST",data:{param:{item:inputItem}},async:!0,success:function(getData){var obj=jQuery.parseJSON(getData);$(".ew-desc").show();$("#InsertDesc").val(obj.desc);$("#InsertDesc").attr("ew-item-code",obj.item);$(".ew-qty").show();$("#InsertQty").val(1);$(".ew-price").show();$("#InsertPrice").val(obj.std);$("#item-id").val(obj.id);if(obj.code!="eWinl"){$(".ew-add").show()}else{$(".ew-add").hide()}}});getSumLine($("#ew-discount-amount").attr("data"),"discount")}}else{$(".find-item").slideUp()}});$("body").on("keydown","#InsertDesc",function(e){if(e.which==13){$("#InsertQty").first().focus()}});$("body").on("keydown","#InsertQty",function(e){if(e.which==13){$("#InsertPrice").first().focus()}});$("body").on("click",".ew-add",function(e){CreateSaleLine()});$("body").on("keydown",".ew-add",function(e){if(e.which==13){CreateSaleLine()}});$("body").on("keydown","#InsertPrice",function(e){if(e.which==13){CreateSaleLine()}});function CreateSaleLine(){if($("#InsertDesc").attr("ew-item-code")==="eWinl"){if($("#InsertType").val()=="G/L"){alert("ขณะนี้ ยังไม่เปิดให้ใช้งาน G/L")}else{alert('ไม่มี Item "'+$(".InsertItem").val()+'"')}}else{if($("#InsertPrice").val()===""||$("#InsertPrice").val()==="0"){alert('คุณกำลังพยายามใส่ "ราคา 0 บาท"')}
var data={param:{itemid:$("#item-id").val(),itemno:$("#InsertDesc").attr("ew-item-code"),orderno:$("#saleheader-no").val(),itemset:0,soid:$("#SaleOrder").attr("ew-so-id"),amount:$("#InsertQty").val(),price:$("#InsertPrice").val(),desc:$("#InsertDesc").val()}};route("index.php?r=SaleOrders/saleorder/create_saleline","POST",data,"SaleLine")}
getSumLine($("#ew-discount-amount").attr("data"),"discount")}
$("body").on("click",".pick-item-to-createline",function(){PickToSaleLine($(this))});function PickToSaleLine($this){var $data={param:{itemno:$this.attr("itemno"),orderno:$("#saleheader-no").val(),itemset:0,soid:$("#SaleOrder").attr("ew-so-id"),amount:1,price:$this.attr("price"),desc:$this.attr("desc")}};route("index.php?r=SaleOrders/saleorder/create_saleline","POST",$data,"SaleLine");LoadAjax();getSumLine($("#ew-discount-amount").attr("data"),"discount")}
$("body").keydown(function(event){if(event.which==27){$("#ew-modal-Approve").modal("hide")}else if(event.which==112){$(".reject-reason #reason-text").focus()}else if(event.which==113){}else if(event.which==114){if(confirm("Create New Document?")){window.location.replace("index.php?r=SaleOrders/saleorder/create")}
return!1}else if(event.which==116){alert("F5")}else if(event.which==118){BtnApprove($("#ew-reject"))}else if(event.which==121){BtnApprove($("#ew-confirm"))}else if(event.which==13){if($(".ew-confirm").is(":visible")){Approve("ew-approve-body",$("#ew-data-text").text())}}});$("body").on("click","#ew-Item-Info",function(){$("#ewItemInfoModal").modal("show");$("#PickToSaleLine").hide();var items=$(this).attr("ew-item-no");$(".ew-item-info-body").show();$(".ew-render-item-info").html('<div style="position:absolute; left:45%;">'+'<i class="fa fa-refresh fa-spin fa-2x fa-fw" aria-hidden="true"></i>'+'<div class="blink" > Loading .... </div></div>');setTimeout(function(e){$(".ew-render-item-info").slideUp();$.ajax({url:"index.php?r=items/items/view-modal",type:"GET",data:{id:items},async:!0,success:function(getData){$(".ew-render-item-info").html(getData).slideDown("slow")}})},1000)});$("body").on("click",".close-ewItemInfoModal",function(){$("#ewSelect").hide();$("#PickToSaleLine").hide();$(".ew-item-info-body").slideToggle();$(".ew-render-item-info").html('<div style="position:absolute; left:45%;">'+'<i class="fa fa-refresh fa-spin fa-2x fa-fw text-success" aria-hidden="true"></i>'+'<div class="blink"> Loading .... </div></div>');setTimeout(function(e){$("#ewItemInfoModal").modal("hide")},350)});$("body").on("click","#ew-modal-pick-cust",function(){route("index.php?r=customers/customer/pick-customer","GET",{search:"",id:$("#SaleOrder").attr("ew-so-id")},"ew-Pick-Customer")});$("body").on("change","#ew-search-text",function(){route("index.php?r=customers/customer/pick-customer","GET",{search:$(this).val(),id:$("#SaleOrder").attr("ew-so-id")},"ew-Pick-Customer")});$("body").on("click","#ew-search-btn",function(){route("index.php?r=customers/customer/pick-customer","GET",{search:$("#ew-search-text").val(),id:$("#SaleOrder").attr("ew-so-id")},"ew-Pick-Customer")});$("body").on("click","#ew-pick-customer",function(){if(confirm("ยืนยันการเลือกลูกค้า ! ")){var tr=$(this).closest("tr");$("#saleheader-customer_id").val($(this).attr("ew-val"));$("#ewPickCustomer").modal("hide");var index=$(this).index()+1;let province=tr.find("td").eq(3).text();let customer=tr.find("a#ew-pick-customer").eq(2).text()+" ("+province.trim()+")";$("#ew-modal-pick-cust").html(customer);$("#saleheader-payment_term").val($(this).attr("data-payment"));$("#customer-payment").addClass("in");$("#SaleOrder").html('<i class="far fa-address-card fa-2x  text-green"></i> '+customer);$("#collapseOne").collapse();$('a[data-target="#customer-infomation"]').hide();var today=new Date();var date=new Date(today),days=parseInt($("#saleheader-payment_term").val(),10);if(!isNaN(date.getTime())){date.setDate(date.getDate()+days);$("#saleheader-paymentdue").val(date.toInputFormat())}}else{return!1}});function getSumLine(discount,key){let data={id:$("a[id=SaleOrder]").attr("ew-so-id"),discount:discount,vat_percent:$("#saleheader-vat_percent").val(),inc_vat:$("#saleheader-include_vat").val(),percent:$("#ew-discount-percent").val(),credit:$("#saleheader-payment_term").val(),due:$("#saleheader-paymentdue").val()};$("body").find(".recommend-discount").fadeOut(300,function(){$(this).remove()});$.ajax({url:"index.php?r=SaleOrders/ajax/percent-discount&key="+key,type:"POST",data:data,dataType:"JSON",success:function(response){$("body").find("div.ew-sum-line").html(response.html).show();let totalDiscount=0;model=response.promo.data;let html='<div class="row recommend-discount" >';html+='    <div class="col-sm-6 col-xs-12 pull-right">';html+='        <a href="#promotions" data-toggle="collapse" data-target="#get-promotions" class="collapsed text-orange get-promotions-switch" aria-expanded="false">';html+='        <i class="far fa-newspaper text-orange blink"></i> '+response.promo.text.label_promotion+"</a>";html+='        <div id="get-promotions" class="'+(switch_promo===1?"collapse fade  in":"collapse fade")+'" >';html+='        <table class="table table-bordered " >';html+="            <thead>";html+='                <tr class="bg-orange">';html+='                    <th class="">'+response.promo.text.label_promotion+"</th>";html+='                    <th class="text-right">'+response.promo.text.label_buy+"</th>";html+='                    <th class="text-right">'+response.promo.text.label_getdiscount+"</th>";html+="                </tr>";html+="            </thead>";html+="            <tbody>";for(i=0;i<model.length;i++){totalDiscount+=model[i].sum_discount;if(model[i].sum_discount>0){let promotion=parseInt(model[i].promotion);discount=parseInt(model[i].sum_discount);curBuy=parseInt(model[i].current_total);disPer=parseInt(model[i].discount_perunit);title="Buy : "+promotion+", Get : "+disPer;html+="            <tr>";html+='                <td class="info" alt="'+title+'" title="'+title+'">'+model[i].name+"</td>";html+='                <td class="text-right">'+number_format(curBuy.toFixed(2))+"</td>";html+='                <td class="text-right">'+number_format(discount.toFixed(2))+"</td>";html+="            </tr>"}}
html+="                <tr>";html+='                    <td colspan="2" class="text-right">'+response.promo.text.label_totaldiscount+"</td>";html+='                    <td class="text-right bg-gray">'+number_format(totalDiscount.toFixed(2))+"</td>";html+="                </tr>";html+="                <tr>";html+='                    <td colspan="3"><small>หมายเหตุ: ส่วนลดนี้ เป็นเพียงส่วนลดที่แนะนำ(เท่านั้น)</small><br /><small>ให้นำไปใส่ในช่อง <u class="text-info" id="click-label-discount">ส่วนลด</u> เพื่อคำนวนอีกครั้ง</small></td>';html+="                </tr>";html+="            </tbody>";html+="        </table>";html+="    </div>";html+="    </div>";html+="</div>";if(totalDiscount>0){$("body").find("div.SaleLine").append($(html).hide().fadeIn(1000))}else{$("body").find(".recommend-discount").fadeOut(300,function(){$(this).remove()})}
$("body").find("input#ew-discount-amount").attr("placeholder",totalDiscount).change()}})}
$("body").on("change","#saleheader-payment_term",function(){var field="payment_term";var data=$(this).val();$.ajax({url:"?r=SaleOrders/saleorder/update-some-field&id="+$("a[id=SaleOrder]").attr("ew-so-id"),type:"POST",data:{field:field,data:data},dataType:"JSON",success:function(res){}});if($(this).val()==="0"){}else{}});$("body").on("change",'input[id="ew-discount-percent"]',function(){var percent_disc=$(this).val();var subtotal=Number($("#ew-line-total").attr("data"));var discount=(subtotal*percent_disc)/100;if(percent_disc===""){discount=$("#ew-discount-amount").attr("data")}
getSumLine(discount,"percent");$('input[id="ew-discount-amount"]').val(discount)});$("body").on("change",'input[id="ew-discount-amount"]',function(){var discount=$(this).val();var subtotal=Number($("#ew-line-total").attr("data"));var percent_disc=(discount/subtotal)*100;getSumLine(discount,"discount");$('input[id="ew-discount-percent"]').val(Math.round(percent_disc*100)/100)});$("body").on("change",".customer_id",function(){var $cust=$(this).val();var $order=$("a#SaleOrder").attr("ew-so-id");$("#ew-modal-pick-cust").text($("#saleheader-customer_id option:selected").text());if($cust!==""){$.ajax({url:"index.php?r=customers/ajax/json-get-customer&id="+$cust,type:"POST",data:{cust:$cust},dataType:"JSON",success:function(response){$("#saleheader-payment_term").val(response.payment_term);$("#saleheader-sale_address").val(response.fulladdress);$("#saleheader-bill_address").val(response.fulladdress);$("#saleheader-ship_address").val(response.fulladdress);$("#customer-payment").addClass("in");$('a[data-target="#customer-infomation"]').hide();var today=new Date();var date=new Date(today),days=parseInt($("#saleheader-payment_term").val(),10);if(!isNaN(date.getTime())){date.setDate(date.getDate()+days);$("#saleheader-paymentdue").val(date.toInputFormat())}}})}});$("body").on("click",".ew-btn-app-click",function(e){BtnApprove(this)});$("body").one("click",".ew-confirm",function(e){Approve("ew-approve-body",$("#ew-data-text").text());$(".modal-footer").hide()});$("body").on("click",".ew-cancel-job",function(e){BtnApprove(this)});function Approve(div,type){var appdata={param:{apk:type,id:$("#SaleOrder").attr("ew-so-id"),cur:$("#SaleOrder").attr("ew-status"),reson:$("#reason-text").text()}};route("index.php?r=approval/approve/sale-order","POST",appdata,div)}
function BtnApprove(e){var text=$(e).attr("ew-data");var input='<label for="reason-text">เหตุผล : </label><textarea class="form-control" id="reason-text" rows="3">ตรวจสอบรายการ</textarea>';var showText=ShowText(text);$("#ew-modal-Approve").modal("toggle");$("#ew-data-text").html(text);$("#ew-showText").html(showText);if(text==="Reject"||text==="Cancel"||text==="Checking"){$(".reject-reason").html(input);if(text==="Cancel"){$("#reason-text").text("สั่งผิด")}}else{$(".reject-reason").html("")}}
function ShowText($text){if($text=="Checking"){return"ยืนยัน!"}else if($text=="Confirm-Cancel"){return"อนุมัติคำขอยกเลิก"}else if($text=="Confirm"){return"อนุมัติ"}else if($text=="Reject"){return"ปฏิเสธ"}
return"ยืนยัน"}
$("body").on("keydown","input#ew-amount",function(event){var keyCode=event.keyCode||event.which;if(keyCode===13){$("input#ew-price").focus().select()}});$("body").on("keydown","input#ew-price",function(event){var keyCode=event.keyCode||event.which;if(keyCode===13){$("#PickToSaleLine").click()}});$("body").on("click",'input[id="ew-price"],input[id="ew-amount"]',function(){var value=$(this).val();$(this).attr("placeholder",value);$(this).val("");$(this).focus().select()});function loadItem($item){$.ajax({url:"index.php?r=SaleOrders/ajax/item-getdata",type:"POST",data:{param:{item:$item}},async:!1,success:function(getData){var obj=jQuery.parseJSON(getData);$("#ew-price").val(0);$("#ew-price").prop("disabled",!0);$("#ew-amount").prop("disabled",!0);$(".ew-render-item").html(obj.desc);$(".ew-itemset-pic").attr("src",obj.Photo)}})}
$("body").on("click","#selector ._radio",function(){$(this).addClass("btn-info").siblings().removeClass("btn-info");itemno=$(this).attr("data");$("#price").val($(this).attr("price"));$("#ItemName").val($(this).attr("item_desc"))});$("body").on("click","#PickToSaleLine",function(){var that=this;$(that).find("i").attr("class","fas fa-sync-alt fa-spin");$(that).attr("disabled",!0);var data={param:{itemid:$("#ew-render-itemno").data("key"),itemno:$("#itemno").val(),orderno:$("#saleheader-no").val(),itemset:$("#itemset").val(),soid:$("#SaleOrder").attr("ew-so-id"),amount:$("#ew-amount").val(),price:$("#ew-price").val()}};$.ajax({url:"index.php?r=SaleOrders/saleorder/create_saleline",type:"POST",data:data,success:function(res){$(".SaleLine").html(res);$.notify({icon:"fas fa-shopping-basket",message:"เพิ่มรายการสินค้าแล้ว"},{placement:{from:"top",align:"center"},type:"warning",delay:3000,z_index:3000});$("html, body").animate({scrollTop:$(".grid-view").offset().top-80},500);LoadAjax();getSumLine($("#ew-discount-amount").attr("data"),"discount");setTimeout(function(){$(that).find("i").attr("class","fa fa-check");$(that).attr("disabled",!1)},1000)}})});$("body").on("click",".ew-action-my-item",function(){var data={param:{pid:$(this).attr("ew-radio-id"),pval:$(this).attr("ew-radio-val"),pset:$("#itemset").val()}};route("index.php?r=SaleOrders/ajax/item-validate","POST",data,"ew-getItem-Set");$("#ew-price").val(0);$(".ew-render-itemno").html("");$(".ew-render-item").html("");$(".text-amount").hide("");$("#ew-price").prop("disabled",!0);$("#ew-amount").prop("disabled",!0);$("#PickToSaleLine").hide();$(".renders-box").slideUp()});$("body").on("click",".ew-action-item",function(){var that=this;$("#itemno").val($(this).attr("ew-radio-item"));$.ajax({url:"index.php?r=SaleOrders/ajax/item-getdata",type:"POST",data:{param:{item:$(this).attr("ew-radio-item")}},async:!1,success:function(getData){var obj=jQuery.parseJSON(getData);$.each($(that).closest("div").find("a"),function(index,el){if(el==that){$(el).find("i").attr("class","far fa-check-square")}else{$(el).find("i").attr("class","far far fa-square")}});$("#ew-render-itemno").attr("data-key",obj.id);$("#ew-price").val(obj.std);$(".ew-render-itemno").html(obj.code);$(".ew-render-item").html(obj.desc);$(".text-amount").html(number_format(obj.inven));$("#ew-price").prop("disabled",!1);$("#ew-amount").prop("disabled",!1);$("#PickToSaleLine").show();$(".ew-itemset-pic").attr("src",obj.Photo).show();if(obj.status==200){$(".renders-box").show();$(".renders-box").find('input[type="number"]:first')}}})});$("body").on("click",".ew-render-itemno",function(){SelectText("ew-render-itemno")});$("body").on("dblclick",".ew-render-itemno",function(){var url="index.php?r=items/items/view&id="+$(this).attr("data-key");window.open(url,"_blank")});function SelectText(element){var doc=document,text=doc.getElementById(element),range,selection;if(doc.body.createTextRange){range=document.body.createTextRange();range.moveToElementText(text);range.select()}else if(window.getSelection){selection=window.getSelection();range=document.createRange();range.selectNodeContents(text);selection.removeAllRanges();selection.addRange(range)}}
function FindItemsJson($this){$(".find-load").fadeIn("fast");$(".find-item-render").html("");$.ajax({url:"index.php?r=items/ajax/find-items-json-limit",type:"GET",data:{word:$this.val(),limit:20},async:!0,success:function(getData){var obj=$.parseJSON(getData);if(obj[0].count==1){createLine(obj[0]);$(".find-item").hide("fast");$(".find-load").fadeOut("fast");$.each($(".SaleLine").find("tr:last"),function(key,model){$(model).find("input:first").focus().select()})}else{var html="";$(".find-item").show("fast");$.each(obj,function(key,model){if(model.count!=0){html+='<a href="#true" data-id="'+model.id+'" itemno="'+model.no+'" desc="'+model.desc_th+'" price="'+model.cost+'"  class="pick-item-to-createline" >'+'<div class="panel panel-info">'+'<div class="panel-body">'+'<div class="row">'+'<div class="col-md-1 col-sm-2"><img src="'+model.img+'" class="img-responsive" style="min-width:50px; margin-bottom:20px;"></div>'+'<div class="col-md-11 col-sm-10">'+'<div class="row">'+'<div class="col-md-10 col-xs-8">'+model.desc_th+"</div>"+'<div class="col-md-2 col-xs-4 text-right">'+'<span class="find-price"><p class="price">Price</p>'+model.cost+"</span>"+"</div>"+"</div>"+'<div class="row">'+'<div class="col-xs-12"><span class="text-sm text-gray">'+model.desc_en+"</span></div>"+'<div class="col-xs-12"><label class="text-black">Code : '+model.item+"</label></div>"+"</div>"+'<div class="row">'+'<div class="col-xs-8"><label>Stock</label></div>'+'<div class="col-xs-4 text-right"><span class="text-gray">'+model.inven+"</span></div>"+"</div>"+"</div>"+"</div>"+"</div>"+"</div>"+"</a>\r\n"}else{html+='<div class="col-md-3">'+'<div class="col-xs-2 text-center"><i class="fas fa-search fa-3x"></i></div>'+'<div class="col-xs-10 text-center">NO DATA FOUND<br/> ไม่พบข้อมูล</div>'+"</div>"}});$(".find-item-render").html(html);setTimeout(function(e){$(".find-item").slideDown("slow");$(".find-load").fadeOut()},100)}}})}
function createLine(itemno){var data={param:{itemid:itemno.id,itemno:itemno.no,orderno:$("#saleheader-no").val(),itemset:0,soid:$("#SaleOrder").attr("ew-so-id"),amount:1,price:itemno.cost,desc:itemno.desc_th}};route("index.php?r=SaleOrders/saleorder/create_saleline","POST",data,"SaleLine");getSumLine($("#ew-discount-amount").attr("data"),"discount")}
$("body").on("click","input[type='number']",function(){$(this).select()});$("body").on("keyup","input.update-desc",function(event){var keyCode=event.keyCode||event.which;if(keyCode===13){var index=$(".text-line").index(this)+1;$(".text-line").eq(index).focus().select()}});$("body").on("change","input.update-desc",function(event){var $this=$(this);var tr=$this.closest("tr");var form=$("form#Form-SaleOrder");var $data={ajax:!0,key:tr.data("key"),name:tr.find($this).attr("name"),data:tr.find($this).val()};var action=form.attr("action");$.ajax({url:action+"&_pjax=%23p0",type:form.attr("method"),data:$data,dataType:"JSON",success:function(response){if(response.status==200){getSumLine($("#ew-discount-amount").attr("data"),"discount")}}})});$("body").on("keyup","input.update-quantity",function(event){var keyCode=event.keyCode||event.which;if(keyCode===13){var index=$(".text-line").index(this)+1;$(".text-line").eq(index).focus().select()}});$("body").on("change","input.update-quantity",function(event){var $this=$(this);var tr=$this.closest("tr");var form=$("form#Form-SaleOrder");var $data={ajax:!0,key:tr.data("key"),name:tr.find($this).attr("name"),data:tr.find($this).val()};var action=form.attr("action");$.ajax({url:action+"&_pjax=%23p0",type:form.attr("method"),data:$data,dataType:"JSON",success:function(response){if(response.status==200){getSumLine($("#ew-discount-amount").attr("data"),"discount");tr.find(".line-amount").text(number_format(response.value.total.toFixed(2)))}}})});$("body").on("keyup","input.update-unit_price",function(event){var keyCode=event.keyCode||event.which;if(keyCode===13){var index=$(".text-line").index(this)+1;if(index==$(".text-line").length){$(".InsertItem").focus().select()}else{$(".text-line").eq(index).focus().select()}}});$("body").on("change","input.update-unit_price",function(event){var $this=$(this);var tr=$this.closest("tr");var form=$("form#Form-SaleOrder");var $data={ajax:!0,key:tr.data("key"),name:tr.find($this).attr("name"),data:tr.find($this).val()};var action=form.attr("action");$.ajax({url:action+"&_pjax=%23p0",type:form.attr("method"),data:$data,dataType:"JSON",success:function(response){if(response.status==200){getSumLine($("#ew-discount-amount").attr("data"),"discount");tr.find(".line-amount").text(number_format(response.value.total.toFixed(2)))}}})})